#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

if [ -n "$COMMIT_SOURCE" ]; then
  exit 0
fi

CHANGED_FILES=$(git diff --cached --name-only)

if [ -z "$CHANGED_FILES" ]; then
  exit 0
fi

PROJECT_FILES=$(echo "$CHANGED_FILES" | grep "/")

if [ -z "$PROJECT_FILES" ]; then
  exit 0
fi

CHANGED_DIRS=$(echo "$PROJECT_FILES" | cut -d'/' -f1 | sort -u)
CHANGED_DIRS=$(echo "$CHANGED_DIRS" | grep -v "^\." | grep -v "^node_modules$")

PROJECTS_CHANGED=$(echo "$CHANGED_DIRS" | wc -l | tr -d ' ')

if [ "$PROJECTS_CHANGED" -eq 1 ] && [ -n "$CHANGED_DIRS" ]; then
  PROJECT_NAME=$(echo "$CHANGED_DIRS" | head -n 1)
  CURRENT_MSG=$(cat "$COMMIT_MSG_FILE")
  
  if ! echo "$CURRENT_MSG" | grep -qE "^[a-zA-Z0-9_-]+:"; then
    echo "$PROJECT_NAME: $CURRENT_MSG" > "$COMMIT_MSG_FILE"
  fi
fi

